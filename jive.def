Bootstrap: docker
From: ubuntu

%environment
  export JEMDIR='/home/user/jem'
  export JIVEDIR='/home/user/jive'
  export MPIDIR='/home/user/openmpi'
  export GMSHDIR='/home/user/gmsh'
  export HDF5DIR='/home/user/hdf5'
  export PATH=$PATH:$MPIDIR/bin
  export PYTHONPATH=$PYTHONPATH:$GMSHDIR/lib
  export LD_RUN_PATH=$LD_RUN_PATH:$MPIDIR/lib:$HDF5DIR/lib


%files
  ./zips/jem-3.0.zip /home/user/
  ./zips/jive-3.0.zip /home/user/
  ./zips/openmpi-4.1.1.tar.gz /home/user/
  ./zips/gmsh-4.9.5-Linux64-sdk.tgz /home/user/
  ./zips/hdf5-1.12.2.tar.gz /home/user/

%post
  export JEMDIR='/home/user/jem'
  export JIVEDIR='/home/user/jive'
  export MPIDIR='/home/user/openmpi'
  export GMSHDIR='/home/user/gmsh'
  export HDF5DIR='/home/user/hdf5'
  export PATH=$MPIDIR/bin:$PATH

  apt update
  apt install -y \
    unzip \
    build-essential \
    g++ zlib1g-dev \
    libreadline-dev \
    freeglut3-dev \
    ssh \
    libxrender-dev \
    libxcursor-dev \
    libxft-dev \
    libxinerama-dev \
    python3-pip \
    python-is-python3 \
    git \
    doxygen \
    graphviz
  pip install \
    numpy \
    pandas \
    scipy \
    h5py \
    termcolor \
    matplotlib \
    pathlib \
    cycler \
    opencv-python \
    meshio \
    svgpathtools \
    pyvista \
    --break-system-packages
  
  cd /home/user/
  
  tar xfz openmpi-4.1.1.tar.gz
  (cd openmpi-4.1.1 && ./configure --prefix=$MPIDIR --disable-wrapper-rpath --disable-wrapper-runpath && make -j -l4 all && make install)
  rm -rf openmpi-4.1.1/

  export LD_LIBRARY_PATH=$MPIDIR:$LD_LIBRARY_PATH
  
  tar xfz hdf5-1.12.2.tar.gz
  (cd hdf5-1.12.2 && ./configure --prefix=$HDF5DIR --with-default-api-version=v110 && make -j -l4 && make -j -l4 check && make install)
  rm -rf hdf5-1.12.2/
  
  export LD_LIBRARY_PATH=$HDF5DIR:$LD_LIBRARY_PATH

  unzip -qq jem-3.0.zip
  mv jem-3.0 jem
  (cd jem && ./configure --cxx=mpic++ --hdf5-libdirs=$HDF5DIR/lib --hdf5-incdirs=$HDF5DIR/include && make -j -l4 && make -j -l4 clean)

  unzip -qq jive-3.0.zip
  mv jive-3.0 jive
  (cd jive && ./configure --cxx=mpic++ && make -j -l4 && make -j -l4 clean)

  tar xfz gmsh-4.9.5-Linux64-sdk.tgz
  mv gmsh-4.9.5-Linux64-sdk gmsh

  rm -f *.zip *.tar.gz *.tgz
  

%labels
  creator t.gartner@tudelft.nl

%help
  This container serves T. GÃ¤rtner as BYOE for the JIVE FE-Enironment.
  It contains JEM, JIVE, openMPI, GMSH and some python libraries for pre/post-processing
